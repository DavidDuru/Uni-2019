---
title: "LabReport3"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## We want to reproduce these results

Twenty genes displayed AML-specific expression changes that were not found in the normal hematopoietic cells. Subsequent analyses using microarray data from 285 additional AML patients confirmed expression changes for 13 of the 20 genes. Seven genes (BIK, CCNA1, FUT4, IL3RA, HOMER3, JAG1, WT1) displayed increased expression in AML, while 6 genes (ALDHA1A, PELO, PLXNC1, PRUNE, SERPINB9, TRIB2) displayed decreased expression. 

Quantitative RT/PCR studies for the 7 over-expressed genes were performed in an independent set of 9 normal and 21 pediatric AML samples. All 7 over-expressed genes displayed an increased expression in the AML samples compared to normals. Three of the 7 over-expressed genes (WT1, CCNA1, and IL3RA) have already been linked to leukemogenesis and/or AML prognosis, while little is known about the role of the other 4 over-expressed genes in AML.


#Attempting to load data
```{r}
getGEO("GSE1159", destdir = ".")

```

```{r}
gds3057 <- getGEO(filename='GDS3057_full.soft.gz')

disease <- gds3057@dataTable@columns
eset <- gds3057@dataTable@table

count3 <- df[,3:66]

rname <- df$ID_REF

rownames(count3) <- rname

tablecols <- tablecols %>% select(-sample)

pheno3 <- tablecols %>% select(-cell.type,-description)
head(tablecols)

head(count3)
head(pheno3)

dim(count3)
head(pheno3)


head(pheno4)

design3 <- model.matrix(~disease_state, pheno3)
head(design3)

library(edgeR)
library(limma)


fir <- lmFit(count3, design3)
fit <- eBayes(fir, robust = TRUE)


results <- decideTests(fit[, "disease_statenormal"])
summary(results)

volcanoplot(fit, coef = "disease_statenormal")

topGenes = topTable(fit, coef = "disease_statenormal", n = 1e+06, p.value = 0.05)
topGenes

hist(fit$p.value[, 2])


#With dge
dge <- DGEList(counts = count3[, rownames(design3)])
dge <- calcNormFactors(dge)

v <- voom(dge, design3, plot = TRUE)

fit <- lmFit(v, design3)

fit <- eBayes(fit, robust = TRUE)

results <- decideTests(fit[, "disease_statenormal"])
summary(results)

hist(fit$p.value[, 2])

volcanoplot(fit, coef = "disease_statenormal")

topGenes = topTable(fit, coef = "disease_statenormal", n = 1e+06, p.value = 0.05)
check_final <- rownames(topGenes)

fuck <- check_final[1:10]

df7 <- df %>% filter(df$ID_REF %in% fuck)

df7


```


```{r}

library(Biobase)
library(GEOquery)
library(dplyr)

gds3057 <- getGEO(filename='GDS3057_full.soft.gz')


glimpse(gds3057)

colnames(Table(gds3057))

Meta(gds3057)$feature_count
Meta(gds3057)$sample_count

Table(gds3057)[1:100,1:6]


tablecols <- gds3057@dataTable@columns

head(tablecols)

disease_state <- tablecols$disease.state

df <- gds3057@dataTable@table

dim(df)

head(df)

#table(duplicated(df$IDENTIFIER))
#table(duplicated(df$ID_REF))

df2 <- df %>% filter(IDENTIFIER == "CCNA1")

df2 <- df2[,3:66]
 
df2
ccna_exp <- df2[1,]
ccna_exp

what <- as.data.frame(cbind(t(ccna_exp)))

what

ccna <- (t(df2))
colnames(ccna) <- c("CCNA Expression Level")

ccna <- cbind(ccna, disease_state)

ccna[,1]
plot(ccna[,1])

ccna <- as.data.frame(ccna)
ccna

library(ggplot2)

ggplot(ccna, aes(rownames(ccna),ccna$`CCNA Expression Level`, colour = disease_state)) +
  geom_point() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, size = 6)) +
  ggtitle("Expression level of CNNA amongst patients with/without leakumia")

ccna

head(ccna)

#ident <- df[,2]
id_ref <- df[,1]

colnames(df3) <- id_ref

head(df3)


head(eset)
countdata <- as.matrix(eset)

head(countdata)

# Get log2 counts per million
logcounts <- log2(countdata + 1)

# make a colour vector
statusCol <- as.numeric(factor(disease_state)) + 1
# Check distributions of samples using boxplots
b <- boxplot(logcounts, 
        xlab="", 
        ylab="Log2(Counts)",
        las=2,
        col=statusCol)


library(ggfortify)
#BiocManager::install("DESeq2")
library(DESeq2)
rlogcounts <- rlog(countdata)
# run PCA
pcDat <- prcomp(t(countdata))
# plot PCA
autoplot(pcDat)


sort(pcDat$rotation[1:10,1])


# setting shape to FALSE causes the plot to default to using the labels
autoplot(pcDat,
         data = disease, 
         colour="disease.state", 
         shape=FALSE,
         label.size=2)


# We estimate the variance for each row in the logcounts matrix
countVar <- apply(rlogcounts, 1, var)
# Get the row numbers for the top 500 most variable genes
highVar <- order(countVar, decreasing=TRUE)[1:500]
# Subset logcounts matrix
hmDat <- rlogcounts[highVar,]


```

```{r}
# We estimate the variance for each row in the logcounts matrix
countVar <- apply(countdata, 1, var)
# Get the row numbers for the top 500 most variable genes
highVar <- order(countVar, decreasing=TRUE)[1:1000]
# Subset logcounts matrix
hmDat <- countdata[highVar,]

library(gplots)
library(RColorBrewer)
# Get some nicer colours
mypalette <- brewer.pal(11, "RdYlBu")
# http://colorbrewer2.org/#type=sequential&scheme=BuGn&n=3
morecols <- colorRampPalette(mypalette)


levels(disease$disease.state)


# Set up colour vector for celltype variable
col.cell <- c("purple","orange")[disease$disease.state]
# Plot the heatmap
heatmap.2(hmDat, 
          col=rev(morecols(50)),
          trace="column", 
          main="Top 500 most variable genes across samples",
          ColSideColors=col.cell,scale="row")

```


```{r}
library(ggplot2)
library(ggfortify)
library(rlang)
library(dplyr)

library(devtools)
install_github('sinhrks/ggfortify')
df3 <- cbind(disease_state, df3)

levels(df3$disease_state)

head(df3)


duplicated(colnames(df3))

check <- df3[, !duplicated(colnames(df3))]

dim(df3)
dim(check)


#df4 <- df3 %>% filter(df3$disease_state == "leukemia") %>% 
              #select(-disease_state)

df4 <- df3 %>% select(-disease_state)

library(edgeR)
dge = DGEList(df4)
x2 <- calcNormFactors(dge, method = "TMM")
cpm2 <- cpm(x2)
cpm2 = cpm2[rownames(df4), ]
head(cpm2)

pca2 = prcomp(cpm2, scale = TRUE )

autoplot(pca2)


#pairs(pca2$x[, 1:3], col = as.factor(df3$disease_state))
#pal = colorRampPalette(c("blue", "red"))(nrow(df4))
#pairs(pca2$x[, 1:3], col = pal[rank(rowSums(df4))])


summary(pca2)$importance[1,1:3]
imp <- sort(pca2$rotation[1:3,1])


imp <- names(imp)
imp




df6 <- df[imp %in% df$ID_REF,]


df7 <- df %>% filter(df$IDENTIFIER %in% test2)

df7
```
```{r}

count3 <- df[,3:66]


rname <- df$ID_REF

rownames(count3) <- rname

tablecols <- tablecols %>% select(-sample)

pheno3 <- tablecols %>% select(-cell.type,-description)
head(tablecols)

head(count3)
head(pheno3)

dim(count3)
head(pheno3)



head(pheno4)

design3 <- model.matrix(~disease_state, pheno3)
head(design3)

library(edgeR)
library(limma)

head(design3)

head(count3)
head(pheno4)

fir <- lmFit(count3, design3)
fit <- eBayes(fir, robust = TRUE)


results <- decideTests(fit[, "disease_statenormal"])
summary(results)

volcanoplot(fit, coef = "disease_statenormal")

topGenes = topTable(fit, coef = "disease_statenormal", n = 1e+06, p.value = 0.05)
topGenes

hist(fit$p.value[, 2])



#With dge

dge <- DGEList(counts = count3[, rownames(design3)])
dge <- calcNormFactors(dge)

v <- voom(dge, design3, plot = TRUE)

fit <- lmFit(v, design3)

fit <- eBayes(fit, robust = TRUE)

results <- decideTests(fit[, "disease_statenormal"])
summary(results)

hist(fit$p.value[, 2])

volcanoplot(fit, coef = "disease_statenormal")

topGenes = topTable(fit, coef = "disease_statenormal", n = 1e+06, p.value = 0.05)
check_final <- rownames(topGenes)

fuck <- check_final[1:10]

df7 <- df %>% filter(df$ID_REF %in% fuck)

df7

```

```{r}
pca = prcomp(df4)

autoplot(pca)

sort(pca$rotation[1:10,1])
sort(pca$rotation[1:10,2])

```



```{r}

#Bad stuff that didnt work
df2 <- df[,1:69]

id_ref <- df2[,1]
ident <- df2[,2]

df2 <- df[,3:66]

df3 <- data.frame(t(df2))
colnames(df3) <- ident


patient_id <- rownames(df3)
patient_id
df3 <- cbind(patient_id, df3)
df3 <- cbind(disease_state, df3)
head(df3)

#boxplot(df3[,3] ~ df3$disease_state)


library(ggplot2)

ggplot(df3, aes(x = colnames(df3$patient_id), y = df3$MIR4640))

duplicated(df3)
```









